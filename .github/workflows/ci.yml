name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  # Parallel validation checks that don't require builds
  validate-format:
    name: Check Formatting
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10.26.2

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: 20
          cache: pnpm

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Check formatting
        run: pnpm format --check

  validate-lint:
    name: Lint Code
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10.26.2

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: 20
          cache: pnpm

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Lint root
        run: pnpm lint:root

      - name: Lint packages
        run: pnpm lint

  validate-deps:
    name: Check Dependencies
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10.26.2

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: 20
          cache: pnpm

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Check dependency versions
        run: pnpm syncpack:check

  # Single build job with Turborepo remote cache
  build:
    name: Build Packages
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          # Full history needed for filtering in PRs
          fetch-depth: 0

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10.26.2

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: 20
          cache: pnpm

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build packages
        run: |
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            echo "ðŸ” PR detected - Building only changed packages..."
            # Get the merge base with the target branch (main)
            BASE=$(git merge-base HEAD origin/main)
            echo "Comparing changes from $BASE to HEAD"
            pnpm build --filter='[$BASE...HEAD]'
          else
            echo "ðŸ“¦ Push to main - Building all packages..."
            pnpm build
          fi

      - name: Validate package.json files
        run: |
          echo "Validating package.json files..."
          FAILED=0

          for pkg in packages/*/package.json; do
            echo "Checking $pkg..."

            # Check required fields
            for field in name version description author license; do
              if ! jq -e ".$field" "$pkg" > /dev/null 2>&1; then
                echo "ERROR: Missing required field '$field' in $pkg"
                FAILED=1
              fi
            done

            # Check files array exists and has content
            if ! jq -e '.files | length > 0' "$pkg" > /dev/null 2>&1; then
              echo "ERROR: Missing or empty 'files' array in $pkg"
              FAILED=1
            fi

            # For packages with build scripts, ensure dist is in files
            if jq -e '.scripts.build' "$pkg" > /dev/null 2>&1; then
              if ! jq -e '.files | map(select(. == "dist")) | length > 0' "$pkg" > /dev/null 2>&1; then
                echo "ERROR: Package has build script but 'dist' not in files array in $pkg"
                FAILED=1
              fi
            fi
          done

          if [ $FAILED -eq 1 ]; then
            echo "Package validation failed"
            exit 1
          fi

          echo "All packages validated successfully"

      - name: Upload build artifacts
        uses: actions/upload-artifact@v6
        with:
          name: build-artifacts
          path: packages/*/dist
          retention-days: 7

  # Test pack using artifacts instead of rebuilding
  test-pack:
    name: Test Package Publishing
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: build
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10.26.2

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: 20
          cache: pnpm

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Download build artifacts
        uses: actions/download-artifact@v6
        with:
          name: build-artifacts
          path: packages

      - name: Pack and validate packages
        run: |
          mkdir -p packed
          FAILED=0
          PACKAGES_VALIDATED=0

          for pkg_dir in packages/*/; do
            pkg_name=$(jq -r '.name' "$pkg_dir/package.json")
            
            # Skip packages that weren't built (no dist folder)
            # This happens in PRs when filtering is used
            if [ ! -d "$pkg_dir/dist" ]; then
              # If package has build script, it should have been built
              if jq -e '.scripts.build' "$pkg_dir/package.json" > /dev/null 2>&1; then
                echo "âš ï¸  Skipping $pkg_name - no dist folder (not built in this run)"
                continue
              else
                # Package doesn't need building, skip it
                echo "â­ï¸  Skipping $pkg_name - no build script"
                continue
              fi
            fi

            echo "=== Packing $pkg_name ==="
            PACKAGES_VALIDATED=$((PACKAGES_VALIDATED + 1))

            cd "$pkg_dir"
            pnpm pack --pack-destination "../../packed"
            cd ../..

            # Find the tarball
            tarball=$(ls packed/*.tgz | grep "$(basename $pkg_dir)" | head -1)
            echo "Created: $tarball"

            # Extract and validate contents
            mkdir -p "validate-$pkg_name"
            tar -xzf "$tarball" -C "validate-$pkg_name"

            # Check package.json exists
            if [ ! -f "validate-$pkg_name/package/package.json" ]; then
              echo "ERROR: package.json missing in $pkg_name"
              FAILED=1
            fi

            # For packages with build output, check dist exists
            if jq -e '.scripts.build' "$pkg_dir/package.json" > /dev/null 2>&1; then
              if [ ! -d "validate-$pkg_name/package/dist" ]; then
                echo "ERROR: dist folder missing in $pkg_name"
                FAILED=1
              fi
            fi

            # Check workspace:* references are resolved
            if grep -q '"workspace:\*"' "validate-$pkg_name/package/package.json"; then
              echo "ERROR: Unresolved workspace:* reference in $pkg_name"
              FAILED=1
            fi

            echo "Contents of $pkg_name:"
            ls -la "validate-$pkg_name/package/"
            echo ""
          done

          if [ $FAILED -eq 1 ]; then
            echo "Package validation failed"
            exit 1
          fi

          echo "âœ… Validated $PACKAGES_VALIDATED package(s) successfully"

  status-check:
    name: CI Status Check
    runs-on: ubuntu-latest
    timeout-minutes: 5
    needs: [validate-format, validate-lint, validate-deps, build, test-pack]
    if: always()
    steps:
      - name: Check job results
        run: |
          if [ "${{ needs.validate-format.result }}" != "success" ] || \
             [ "${{ needs.validate-lint.result }}" != "success" ] || \
             [ "${{ needs.validate-deps.result }}" != "success" ] || \
             [ "${{ needs.build.result }}" != "success" ] || \
             [ "${{ needs.test-pack.result }}" != "success" ]; then
            echo "One or more CI jobs failed"
            exit 1
          fi
          echo "All CI jobs completed successfully"
