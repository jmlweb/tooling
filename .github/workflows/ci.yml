name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  # Parallel validation checks that don't require builds
  validate-format:
    name: Check Formatting
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          # Shallow clone sufficient - no git operations needed
          fetch-depth: 1

      - name: Setup environment
        uses: ./.github/actions/setup
        with:
          restore-turbo-cache: true

      - name: Build prettier configs (required for format check)
        run: pnpm build --filter='@jmlweb/prettier-config-*'

      - name: Check formatting
        run: pnpm format --check

  validate-lint:
    name: Lint Code
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          # Shallow clone sufficient - no git operations needed
          fetch-depth: 1

      - name: Setup environment
        uses: ./.github/actions/setup
        with:
          restore-turbo-cache: true

      - name: Build eslint configs (required for lint check)
        run: pnpm build --filter='@jmlweb/eslint-config-*'
        env:
          TURBO_TOKEN: ${{ secrets.TURBO_TOKEN }}
          TURBO_TEAM: ${{ vars.TURBO_TEAM }}

      - name: Lint root
        run: pnpm lint:root

      - name: Lint packages
        run: pnpm lint
        env:
          TURBO_TOKEN: ${{ secrets.TURBO_TOKEN }}
          TURBO_TEAM: ${{ vars.TURBO_TEAM }}

  validate-deps:
    name: Check Dependencies
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          # Shallow clone sufficient - no git operations needed
          fetch-depth: 1

      - name: Setup environment
        uses: ./.github/actions/setup

      - name: Check dependency versions
        run: pnpm syncpack:check

  # Single build job with Turborepo remote cache
  build:
    name: Build Packages
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          # Full history needed for PR filtering (git merge-base calculation)
          fetch-depth: 0

      - name: Setup environment
        uses: ./.github/actions/setup
        with:
          restore-turbo-cache: true

      - name: Build packages
        run: node scripts/ci-build.mjs
        env:
          GITHUB_EVENT_NAME: ${{ github.event_name }}
          GITHUB_BASE_REF: ${{ github.base_ref }}
          TURBO_TOKEN: ${{ secrets.TURBO_TOKEN }}
          TURBO_TEAM: ${{ vars.TURBO_TEAM }}

      - name: Validate package.json files
        run: pnpm validate:packages

      - name: Upload build artifacts
        uses: actions/upload-artifact@v7
        continue-on-error: true
        with:
          name: build-artifacts
          path: packages/*/dist
          retention-days: 7
        if: always()

  # Test pack using artifacts instead of rebuilding
  test-pack:
    name: Test Package Publishing
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: build
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          # Shallow clone sufficient - no git operations needed
          fetch-depth: 1

      - name: Setup environment
        uses: ./.github/actions/setup
        with:
          restore-turbo-cache: true

      - name: Download build artifacts
        uses: actions/download-artifact@v7
        with:
          name: build-artifacts
          path: packages

      - name: Pack and validate packages
        run: node scripts/test-pack.mjs

  integration-test:
    name: Integration Tests
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: build
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          # Shallow clone sufficient - no git operations needed
          fetch-depth: 1

      - name: Setup environment
        uses: ./.github/actions/setup
        with:
          restore-turbo-cache: true

      - name: Run integration tests
        run: pnpm integration:test
        env:
          TURBO_TOKEN: ${{ secrets.TURBO_TOKEN }}
          TURBO_TEAM: ${{ vars.TURBO_TEAM }}

  status-check:
    name: CI Status Check
    runs-on: ubuntu-latest
    timeout-minutes: 5
    needs: [validate-format, validate-lint, validate-deps, build, test-pack, integration-test]
    if: always()
    steps:
      - name: Check job results
        run: |
          if [ "${{ needs.validate-format.result }}" != "success" ] || \
             [ "${{ needs.validate-lint.result }}" != "success" ] || \
             [ "${{ needs.validate-deps.result }}" != "success" ] || \
             [ "${{ needs.build.result }}" != "success" ] || \
             [ "${{ needs.test-pack.result }}" != "success" ] || \
             [ "${{ needs.integration-test.result }}" != "success" ]; then
            echo "One or more CI jobs failed"
            exit 1
          fi
          echo "All CI jobs completed successfully"
