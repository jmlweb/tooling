name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  validate:
    name: Validate Code Quality
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10.26.2

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: pnpm

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build packages
        run: pnpm build

      - name: Check formatting
        run: pnpm format --check

      - name: Lint root
        run: pnpm lint:root

      - name: Lint packages
        run: pnpm lint

      - name: Check dependency versions
        run: pnpm syncpack:check

  build:
    name: Build Packages
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10.26.2

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: pnpm

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build packages
        run: pnpm build

      - name: Validate package.json files
        run: |
          echo "Validating package.json files..."
          FAILED=0

          for pkg in packages/*/package.json; do
            echo "Checking $pkg..."

            # Check required fields
            for field in name version description author license; do
              if ! jq -e ".$field" "$pkg" > /dev/null 2>&1; then
                echo "ERROR: Missing required field '$field' in $pkg"
                FAILED=1
              fi
            done

            # Check files array exists and has content
            if ! jq -e '.files | length > 0' "$pkg" > /dev/null 2>&1; then
              echo "ERROR: Missing or empty 'files' array in $pkg"
              FAILED=1
            fi

            # For packages with build scripts, ensure dist is in files
            if jq -e '.scripts.build' "$pkg" > /dev/null 2>&1; then
              if ! jq -e '.files | map(select(. == "dist")) | length > 0' "$pkg" > /dev/null 2>&1; then
                echo "ERROR: Package has build script but 'dist' not in files array in $pkg"
                FAILED=1
              fi
            fi
          done

          if [ $FAILED -eq 1 ]; then
            echo "Package validation failed"
            exit 1
          fi

          echo "All packages validated successfully"

      - name: Upload build artifacts
        uses: actions/upload-artifact@v6
        with:
          name: build-artifacts
          path: packages/*/dist
          retention-days: 7

  test-pack:
    name: Test Package Publishing
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: build
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10.26.2

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: pnpm

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build packages
        run: pnpm build

      - name: Pack and validate packages
        run: |
          mkdir -p packed
          FAILED=0

          for pkg_dir in packages/*/; do
            pkg_name=$(jq -r '.name' "$pkg_dir/package.json")
            echo "=== Packing $pkg_name ==="

            cd "$pkg_dir"
            pnpm pack --pack-destination "../../packed"
            cd ../..

            # Find the tarball
            tarball=$(ls packed/*.tgz | grep "$(basename $pkg_dir)" | head -1)
            echo "Created: $tarball"

            # Extract and validate contents
            mkdir -p "validate-$pkg_name"
            tar -xzf "$tarball" -C "validate-$pkg_name"

            # Check package.json exists
            if [ ! -f "validate-$pkg_name/package/package.json" ]; then
              echo "ERROR: package.json missing in $pkg_name"
              FAILED=1
            fi

            # For packages with build output, check dist exists
            if jq -e '.scripts.build' "$pkg_dir/package.json" > /dev/null 2>&1; then
              if [ ! -d "validate-$pkg_name/package/dist" ]; then
                echo "ERROR: dist folder missing in $pkg_name"
                FAILED=1
              fi
            fi

            # Check workspace:* references are resolved
            if grep -q '"workspace:\*"' "validate-$pkg_name/package/package.json"; then
              echo "ERROR: Unresolved workspace:* reference in $pkg_name"
              FAILED=1
            fi

            echo "Contents of $pkg_name:"
            ls -la "validate-$pkg_name/package/"
            echo ""
          done

          if [ $FAILED -eq 1 ]; then
            echo "Package validation failed"
            exit 1
          fi

          echo "All packages validated successfully"

  status-check:
    name: CI Status Check
    runs-on: ubuntu-latest
    timeout-minutes: 5
    needs: [validate, build, test-pack]
    if: always()
    steps:
      - name: Check job results
        run: |
          if [ "${{ needs.validate.result }}" != "success" ] || \
             [ "${{ needs.build.result }}" != "success" ] || \
             [ "${{ needs.test-pack.result }}" != "success" ]; then
            echo "One or more CI jobs failed"
            exit 1
          fi
          echo "All CI jobs completed successfully"
